<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ü§ñ AI Code Review & Rewrite Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css" id="hljs-theme">
    
    <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        body { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); transition: all 0.3s ease; }
        .tab-active { border-bottom: 3px solid #a855f7; color: #a855f7; }
        #loading { display: none; }
        #loading.active { display: flex; }
        
        /* Diff Styling */
        .diff-added { background-color: rgba(34, 197, 94, 0.2); color: #4ade80; border-left: 3px solid #22c55e; }
        .diff-removed { background-color: rgba(239, 68, 68, 0.2); color: #f87171; border-left: 3px solid #ef4444; text-decoration: line-through; }
        
        /* Light Mode Overrides */
        .light-theme { background: #f8fafc; color: #1e293b; }
        .light-theme .bg-gray-800 { background: #ffffff; border: 1px solid #e2e8f0; color: #1e293b; }
        .light-theme .bg-gray-700 { background: #f1f5f9; border: 1px solid #e2e8f0; color: #1e293b; }
        .light-theme .text-gray-400 { color: #64748b; }
    </style>
</head>
<body class="text-gray-100 min-h-screen">
    
    <nav class="bg-gray-800 border-b border-gray-700 p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <span class="text-4xl">ü§ñ</span>
                <div>
                    <h1 class="text-xl font-bold text-purple-400">Code Review Agent</h1>
                    <p class="text-xs text-gray-400">Powered by Groq + Llama 3.3</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button onclick="toggleTheme()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded">
                    <i id="themeIcon" class="fas fa-moon"></i>
                </button>
                <button onclick="window.location.href='/'" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded flex items-center space-x-2">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        
        <div class="text-center mb-8">
            <h2 class="text-4xl font-bold text-purple-400 mb-2">Intelligent Code Review & Rewrite</h2>
            <p class="text-gray-400">Get instant feedback on your code using ultra-fast Llama 3.3-70B inference.</p>
        </div>

        <div class="flex justify-center space-x-8 mb-6 border-b border-gray-700">
            <button id="tabReview" class="tab-active pb-2 px-4 font-semibold transition" onclick="switchTab('review')">
                <i class="fas fa-search mr-2"></i> Code Review
            </button>
            <button id="tabRewrite" class="pb-2 px-4 font-semibold transition text-gray-400" onclick="switchTab('rewrite')">
                <i class="fas fa-pen mr-2"></i> Rewritten Code
            </button>
        </div>

        <div id="contentReview" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                <h3 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-code mr-2 text-blue-400"></i> Your Code</h3>
                
                <div class="mb-4">
                    <select id="language" class="w-full bg-gray-700 text-white px-4 py-2 rounded border border-gray-600 focus:border-purple-500 outline-none">
                        <option value="python">üêç Python</option>
                        <option value="javascript">üìú JavaScript</option>
                        <option value="csharp">üéØ C#</option>
                        <option value="java">‚òï Java</option>
                    </select>
                </div>
                
                <textarea id="codeInput" rows="10" class="w-full bg-gray-700 text-white px-4 py-2 rounded border border-gray-600 font-mono text-sm mb-4" placeholder="Paste code here..."></textarea>

                <div id="terminal" class="bg-black rounded p-4 font-mono text-xs text-green-400 h-32 overflow-y-auto mb-4 border border-gray-700 hidden">
                    <div id="terminalBody"></div>
                </div>
                
                <button id="btnReview" onclick="reviewCode()" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 rounded mb-2">
                    <i class="fas fa-search mr-2"></i> Review Code
                </button>
                <button id="btnRewrite" onclick="rewriteCode()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded">
                    <i class="fas fa-pen mr-2"></i> Fix & Rewrite Code
                </button>
            </div>
            
            <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                <h3 class="text-xl font-bold mb-4 flex items-center"><i class="fas fa-clipboard-list mr-2 text-green-400"></i> Review Results</h3>
                
                <div class="grid grid-cols-4 gap-2 mb-4">
                    <div class="bg-red-900/30 border border-red-500 rounded p-2 text-center">
                        <p class="text-xs text-gray-400">Critical</p>
                        <p id="criticalCount" class="text-xl font-bold text-red-400">0</p>
                    </div>
                    <div class="bg-orange-900/30 border border-orange-500 rounded p-2 text-center">
                        <p class="text-xs text-gray-400">High</p>
                        <p id="highCount" class="text-xl font-bold text-orange-400">0</p>
                    </div>
                    <div class="bg-yellow-900/30 border border-yellow-500 rounded p-2 text-center">
                        <p class="text-xs text-gray-400">Med</p>
                        <p id="mediumCount" class="text-xl font-bold text-yellow-400">0</p>
                    </div>
                    <div class="bg-green-900/30 border border-green-500 rounded p-2 text-center">
                        <p class="text-xs text-gray-400">Low</p>
                        <p id="lowCount" class="text-xl font-bold text-green-400">0</p>
                    </div>
                </div>
                
                <div id="reviewContent" class="bg-gray-900 rounded p-4 h-[350px] overflow-y-auto text-sm">
                    <p class="text-gray-500 text-center py-8">Review results will appear here.</p>
                </div>
            </div>
        </div>

        <div id="contentRewrite" class="hidden grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-gray-800 rounded-lg p-6 shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-red-400">Original Code</h3>
                <div id="originalCode" class="bg-gray-900 rounded p-4 h-[400px] overflow-auto text-xs font-mono"></div>
            </div>
            
            <div class="bg-gray-800 rounded-lg p-6 shadow-lg relative">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-green-400">Rewritten Code</h3>
                    <button onclick="mockGithubPR()" class="bg-indigo-600 hover:bg-indigo-700 text-xs font-bold py-2 px-4 rounded flex items-center">
                        <i class="fab fa-github mr-2"></i> CREATE PR
                    </button>
                </div>
                <div id="rewrittenCode" class="bg-gray-900 rounded p-4 h-[400px] overflow-auto text-xs font-mono"></div>
            </div>
        </div>
    </div>

    <div id="prPopup" class="fixed bottom-10 right-10 bg-gray-800 border-l-4 border-indigo-500 p-6 rounded shadow-2xl transform translate-y-40 transition-transform duration-500 flex items-center space-x-4 z-[100]">
        <i class="fab fa-github text-indigo-400 text-3xl"></i>
        <div>
            <p class="text-white font-bold">Success!</p>
            <p class="text-gray-400 text-sm">PR #1024: Security Patch Created</p>
        </div>
    </div>

    <div id="loading" class="fixed inset-0 bg-black/75 items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-purple-500 mx-auto mb-4"></div>
            <p class="text-white">AI is processing...</p>
        </div>
    </div>

    <script>
        // --- 1. THEME TOGGLE ---
        function toggleTheme() {
            document.body.classList.toggle('light-theme');
            const icon = document.getElementById('themeIcon');
            icon.classList.toggle('fa-moon');
            icon.classList.toggle('fa-sun');
            const themeLink = document.getElementById('hljs-theme');
            themeLink.href = document.body.classList.contains('light-theme') 
                ? "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" 
                : "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css";
        }

        // --- 2. AI THINKING LOGS ---
        async function runThinkingLogs() {
            const terminal = document.getElementById('terminal');
            const body = document.getElementById('terminalBody');
            terminal.classList.remove('hidden');
            body.innerHTML = "";
            const logs = [
                "> Initializing Llama 3.3 70B",
                "> Analyzing code structure via AST...",
                "> Scanning for security vulnerabilities",
                "> Optimized code generated."
            ];
            for (const log of logs) {
                const p = document.createElement('p');
                p.innerText = log;
                body.appendChild(p);
                await new Promise(r => setTimeout(r, 600));
            }
        }

        // --- 3. DIFF VIEWER ---
        function renderDiff(oldCode, newCode) {
            const diff = Diff.diffLines(oldCode, newCode);
            const originalDiv = document.getElementById('originalCode');
            const rewrittenDiv = document.getElementById('rewrittenCode');
            originalDiv.innerHTML = "";
            rewrittenDiv.innerHTML = "";

            diff.forEach(part => {
                const colorClass = part.added ? 'diff-added' : part.removed ? 'diff-removed' : '';
                const line = `<div class="${colorClass} px-2 whitespace-pre">${escapeHtml(part.value)}</div>`;
                if (part.added) rewrittenDiv.innerHTML += line;
                else if (part.removed) originalDiv.innerHTML += line;
                else {
                    originalDiv.innerHTML += line;
                    rewrittenDiv.innerHTML += line;
                }
            });
            hljs.highlightAll();
        }

        // --- 4. GITHUB MOCKUP ---
        function mockGithubPR() {
            const popup = document.getElementById('prPopup');
            popup.style.transform = "translateY(0)";
            setTimeout(() => { popup.style.transform = "translateY(200px)"; }, 4000);
        }

        // --- TAB LOGIC ---
        function switchTab(tab) {
            document.getElementById('contentReview').classList.toggle('hidden', tab !== 'review');
            document.getElementById('contentRewrite').classList.toggle('hidden', tab !== 'rewrite');
            if(tab === 'review') document.getElementById('contentReview').classList.add('grid');
            if(tab === 'rewrite') document.getElementById('contentRewrite').classList.add('grid');
            document.getElementById('tabReview').className = tab === 'review' ? 'tab-active pb-2 px-4 font-semibold transition' : 'pb-2 px-4 font-semibold transition text-gray-400';
            document.getElementById('tabRewrite').className = tab === 'rewrite' ? 'tab-active pb-2 px-4 font-semibold transition' : 'pb-2 px-4 font-semibold transition text-gray-400';
        }

        // --- REVIEW API CALL ---
        async function reviewCode() {
            const code = document.getElementById('codeInput').value;
            if (!code) return alert("Paste code first");
            await runThinkingLogs();
            document.getElementById('loading').classList.add('active');
            
            try {
                const response = await fetch('http://127.0.0.1:8000/api/review', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code, language: document.getElementById('language').value, focus_areas: ["Bugs", "Security"]})
                });
                const data = await response.json();
                document.getElementById('criticalCount').textContent = data.critical_count;
                document.getElementById('reviewContent').innerHTML = marked.parse(data.review);
                hljs.highlightAll();
            } catch (e) { alert("Server error"); } 
            finally { document.getElementById('loading').classList.remove('active'); }
        }

        // --- REWRITE API CALL ---
        async function rewriteCode() {
            const code = document.getElementById('codeInput').value;
            document.getElementById('loading').classList.add('active');
            try {
                const response = await fetch('http://127.0.0.1:8000/api/rewrite', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({code, language: document.getElementById('language').value})
                });
                const data = await response.json();
                renderDiff(code, data.rewritten_code);
                switchTab('rewrite');
            } catch (e) { alert("Server error"); } 
            finally { document.getElementById('loading').classList.remove('active'); }
        }

        function escapeHtml(text) {
            const map = {'&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;'};
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>